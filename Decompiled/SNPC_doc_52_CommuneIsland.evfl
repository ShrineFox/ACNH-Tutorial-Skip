flow AfterJuneBrideFirstEv():
	run Event95()

flow ChkUnlockDirectRoute():
	if not System.EventFlags['cPlayer:DocUnlockSpnOtgDirectRoute']:
		# Oh, right! I'm supposed to mention that we've expanded our little operation. Now we've got direct flights to Paradise Planning, which should reduce y…
		MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:1106', false)
		System.EventFlags['cPlayer:DocUnlockSpnOtgDirectRoute'] = true
		if System.EventFlags['cPlayer:DocDeliveryPurchaseExplain']:
			# Alright, so…what would you like to do?
			MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:1107', false)
			run ReturnDirectRoute()
		else:
			# Alright, so…what would you like to do?
			MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:1108', false)
			run ReturnDirectRoute_Sel3()
		EventFlowSystemActor.ExitFlowchart()

flow Chk_CommuneExpandEvent_Arrive():
	if System.EventFlags['cPlayer:ReserveCommuneExpansion']:
		# The dodo has landed!
		MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:1001', true)
		MainNpc.TurnNeck(11, false)
		MainNpc.TurnBody(12, 190.0)
		MainNpc.NpcWaitTurn()
		MainNpc.CharacterEmoticonAction('Eh', true, '', 0, false)
		EventFlowSystemActor.WaitFrame(30)
		MainNpc.TurnBody(10, 0.0)
		# Hold on—Harvey is AWOL! Not like him to abandon his post…or do much of anything, really. Except…there's a new path over there. Land-based recon's not…
		MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:1002', true)
		EventFlowSystemActor.ExitFlowchart()

flow Chk_CommuneExpandEvent_Wait():
	if System.EventFlags['cPlayer:ReserveCommuneExpansion']:
		if not System.EventFlags['cPlayer:SpnExpandEventAfterJuneBride']:
entrypoint Event95:
			# Did you find Harvey? He could be farther in on the island…
			MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:1003', false)
			EventFlowSystemActor.ExitFlowchart()
		elif System.EventFlags['cPlayerTemp:DocSpnExpandEventAfterJuneBride']:
			run AfterJuneBrideFirstEv()
		else:
			# I should report that Harvey was looking for you. Something besides photography this time. Looks like he's even built a new path past the photo studio…
			MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:1004', false)
			System.EventFlags['cPlayerTemp:DocSpnExpandEventAfterJuneBride'] = true
			EventFlowSystemActor.ExitFlowchart()

flow Doc_Cancel():
	# Mission scrubbed, eh? Well, come see me again if you want to take another run at it.
	MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:113', false)
	EventFlowSystemActor.ExitFlowchart()

flow Doc_CancelGo():
	# Copy that. Take your time, civilian. I'm not in a hurry.
	MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:104', true)

flow Doc_CommuneExpansionWalk():
	Player.PlayerMoveToTarget(false, 715.0, 635.0, 0.0, 0.0, true, 'cDemoTalk')
	EventFlowSystemActor.WaitFrame(15)
	EventFlowSystemActor.SetNpcAIBlackBoardByLabel('spn', 'CommuneDemoSpeak', 1, 1)

flow Doc_Delivery():
	# Delivery, huh? Copy that, loud and clear. What are we sending out into the wild blue yonder?
	MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:111', false)
	EventFlowSystemActor.UIItemSelectWindowHandling('cMoveToChest', 65534, '', '', 'cItemSelect', false)
	if not EventFlowSystemActor.UIResultMenuDecide():
		run Doc_Cancel()
	elif EventFlowSystemActor.UISelectedItemCanMoveChest():
		EventFlowSystemActor.UISelectedItemMoveChest()
		# Roger. Your cargo is cleared for departure.
		MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:116', false)
		# Dodo delivery service is wings-up and ready for takeoff. We'll get your stuff home safely.
		MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:118', false)
		run Doc_Thanks()
	else:
		# Huh? Mission scrubbed! Too much congestion in your storage back home… You're full up. If you want to alter your flight plan and sell some stuff inste…
		MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:112', false)

flow Doc_DeliveryPurchaseExplain():
	if not System.EventFlags['cPlayer:DocDeliveryPurchaseExplain']:
		if (EventFlowSystemActor.TermEventNow('JuneBride', false)) and (System.EventFlags['cPlayer:SpnJuneBrideTalkEventFrag']):
			run Sub_Event53()
		else:
			run SNPC_spn_02_Commune::ChkEnableDonation()
			if SubflowResults@3[2] in (1, 2):
				run Sub_Event53()

flow Doc_FirstJuneBride():
	EventFlowSystemActor.StoreNormalCamera(false, '')
	# Touchdown like <135:8:cd00> in [a|an]<135:5:cd00>—we are parked and proud! Give a quack to wingback.
	MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:001', true)
	MainNpc.TurnBody(12, 190.0)
	# <50:3><135:7:cd00> static! Looks like we got a whole lotta radio chatter goin' on over yonder…
	MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:002', true)
	EventFlowSystemActor.StoreNormalCamera(false, '')
	EventFlowSystemActor.WaitFrame(15)

flow Doc_FirstJuneBrideWalk():
	if System.EventFlags['cLand:CommuneExpanded']:
		Player.PlayerMoveToTarget(false, 685.0, 847.0, 0.0, 0.0, true, 'cDemoTalk')
	else:
		Player.PlayerMoveToTarget(false, 365.0, 527.0, 0.0, 0.0, true, 'cDemoTalk')
	EventFlowSystemActor.SetNpcAIBlackBoardByLabel('spn', 'DemoSpeak', 1, 1)

flow Doc_GoAOC():
	if not EventFlowSystemActor.IsWherearenAocAvailable():
		run SNPC_dod_40_Airport_Wherearen::NoAoC()
	elif EventFlowSystemActor.EnvHourOverGrowUp():
		# Sorry—that's a nega-ton negatory right now. Can't send flights that way because of…classified stuff. Regs say you'll need to pop back home, then catc…
		MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:1105', false)
	else:
		# Ah, so you're going to work! Roger that!
		MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:1102', false)
		# I can set you up right now, but are you ready? All packed and stuff?
		MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:1103', false)
		if EventFlowSystemActor.GeneralTalkChoice2() == 0:
			# Roger! Let's pack snacks and make tracks.
			MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:1104', true)
			System.EventFlags['cPlayerTemp:DocCommuneIslandFirstTalkDone'] = false
			run SNPC_dod_40_Airport_Wherearen::Dod_GoToWherearen()
		else:
			run Doc_CancelGo()

flow Doc_GoMainIsland():
	# You wanna bust bunson burners and bounce back to <50:3><110:7:cd00>town?
	MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:102', false)
	if EventFlowSystemActor.GeneralTalkChoice2() == 0:
		# Roger! Let's pack snacks and make tracks.
		MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:103', true)
		System.EventFlags['cPlayerTemp:DocCommuneIslandFirstTalkDone'] = false
		EventFlowSystemActor.BGMPropertyControl(76)
		EventFlowSystemActor.SoundTriggerEmit('Airplane_Takeoff_Short', -1)
		System.EventFlags['cLandTemp:DocReturnFromIsland'] = true
		EventFlowSystemActor.SystemRequestChangeStage('cFromOutlierToHomeland', 'cDALWithLoadWait', 'cCircle', 'cBlack', 1.0, 1.0)
	else:
		run Doc_CancelGo()

flow Doc_NoService():
	# Trainwreck <135:7:cd00> is reporting tango <135:6:cd00> is go. Do you require assistance? Over.
	MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:101', false)
	if EventFlowSystemActor.GeneralTalkChoice2() == 0:
		run Doc_GoMainIsland()
	else:
		run Doc_CancelGo()

flow Doc_Purchase(SellTotal: int = 0):
	if EventFlowSystemActor.PurchaseBoxFreeQuery2('cPurchaseBoxQueryType_SavingFull', 0):
		# Abort mission! Your Bank of Nook account is at capacity, so this service is a no-go at the moment… So…we can't land any funds in your account, but we…
		MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:121', false)
		if EventFlowSystemActor.GeneralTalkChoice2() == 0:
			# Affirmative! What are we taking off your hands?
			MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:124', false)
			EventFlowSystemActor.UIItemSelectWindowHandling('cSellBox', 65534, '', '', 'cItemSelect', false)
			if EventFlowSystemActor.UIResultMenuDecide():
				EventFlowSystemActor.SystemDeletePlayerItem('cItemWindow', 1)
				# Cargo received! We'll discard your excess baggage for you.
				MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:126', false)
				run Doc_Thanks()
			else:
				run Doc_Cancel()
		else:
			run Doc_Cancel()
	else:
		# Offloading some excess cargo for Bells, eh? What's on the manifest?
		MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:120', false)
		EventFlowSystemActor.UIItemSelectWindowHandling('cSellBox', 65534, '', '', 'cPurchaseBox', false)
		if EventFlowSystemActor.UIResultMenuDecide():
			EventFlowSystemActor.ShopSellCalc(SellTotal, 1.0, false, true)
			EventFlowSystemActor.ShopSellDone(1.0, true)
			System.EventFlags['cLifeSupportAchievement:SellItemRcm'] += 1
			System.EventFlags['cPlayer:DocUsePurchaseServiceFalg'] = true
			# Confirming receipt of goods! Payment lands tomorrow morning.
			MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:125', false)
			run Doc_Thanks()
		else:
			run Doc_Cancel()

flow Doc_Service():
	run Chk_CommuneExpandEvent_Wait()
	run Doc_DeliveryPurchaseExplain()
	if (System.EventFlags['cPlayer:CommuneCompleteExpandEvent_Player']) and (System.EventFlags['cPlayer:WHEREAREN_VisitDone']):
		run ChkUnlockDirectRoute()
		if System.EventFlags['cPlayer:DocDeliveryPurchaseExplain']:
			# Trainwreck <135:7:cd00> is reporting tango <135:6:cd00> is go. Do you require assistance? Over.
			MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:1101', false)
			run ReturnDirectRoute()
		else:
			# Trainwreck <135:7:cd00> is reporting tango <135:6:cd00> is go. Do you require assistance? Over.
			MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:1100', false)
			run ReturnDirectRoute_Sel3()
	elif System.EventFlags['cPlayer:DocDeliveryPurchaseExplain']:
		# Trainwreck <135:7:cd00> is reporting tango <135:6:cd00> is go. Do you require assistance? Over.
		MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:110', false)
		switch EventFlowSystemActor.GeneralTalkChoice4():
			case 0:
				run Doc_GoMainIsland()
			case 1:
				run Doc_Delivery()
			case 2:
				run Doc_Purchase()
			case 3:
				run Doc_CancelGo()
	else:
		run Doc_NoService()

flow Doc_Thanks():
	# Dodo Airlines: Flying because we can.
	MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:127', false)
	EventFlowSystemActor.ExitFlowchart()

flow ReturnDirectRoute():
	switch EventFlowSystemActor.GeneralTalkChoice5():
		case 0:
			run Doc_GoMainIsland()
		case 1:
			run Doc_GoAOC()
		case 2:
			run Doc_Delivery()
		case 3:
			run Doc_Purchase()
		case 4:
			run Doc_CancelGo()

flow ReturnDirectRoute_Sel3():
	switch EventFlowSystemActor.GeneralTalkChoice3():
		case 0:
			run Doc_GoMainIsland()
		case 1:
			run Doc_GoAOC()
		case 2:
			run Doc_CancelGo()

flow Root():
	if not System.EventFlags['cPlayerTemp:DocCommuneIslandFirstTalkDone']:
		System.EventFlags['cPlayerTemp:DocCommuneIslandFirstTalkDone'] = true
		if (EventFlowSystemActor.TermEventNow('JuneBride', false)) and (System.EventFlags['cPlayer:CommuneIslandAvailable']) and (not System.EventFlags['cPlayer:SpnJuneBrideTalkEventFrag']):
			run Doc_FirstJuneBride()
		else:
			run Chk_CommuneExpandEvent_Arrive()
			# Touchdown like <135:8:cd00> in [a|an]<135:5:cd00>—we are parked and proud! Give a quack to wingback.
			MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:001', true)
	elif not EventFlowSystemActor.TermEventNow('JuneBride', false):
		run Doc_Service()
	elif not System.EventFlags['cPlayer:CommuneIslandAvailable']:
		run Doc_Service()
	elif System.EventFlags['cPlayer:SpnJuneBrideTalkEventFrag']:
		run Doc_Service()
	else:
		# Wanna dodo some recon?
		MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:200', false)

local flow Sub_Event53():
	# Attention, fledgling! This squawker's got a transmission for you. Yes, you, PLAYER… Dodo Airlines is now dabbling in item delivery and liquidation, h…
	MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:105', false)
	# First, let's talk delivery. We'll ship your goods, safe and sound, straight to your home storage. And we won't bombard you with pesky handling fees, …
	MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:106', false)
	# As for liquidation, well, let me just confirm that dodos are collectors. Maybe your intel on that was lacking. But it's true! And this service is for…
	MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:107', false)
	# That's all the dodo info on these new services for now. Dodo Airlines, over and out!
	MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:108', false)
	System.EventFlags['cPlayer:DocDeliveryPurchaseExplain'] = true
	System.EventFlags['cPlayer:PlayerPocketUIEnableInCommuneIsland'] = true
	EventFlowSystemActor.ExitFlowchart()
