flow Root():
    if not EventFlowSystemActor.IsMyVillage():
        if not System.EventFlags['cPlayerVisit:KppTalkFlag']:
            # Avast! Be ye from the distant shores o' another island? Well, enjoy yer time here. And mind yer manners!
            MainNpc.OpenMessageWindow('TalkSNpc/kpp/SP_kpp:014', false)
            System.EventFlags['cPlayerVisit:KppTalkFlag'] = true
        elif EventFlowSystemActor.RandomChoiceExcludePrevious2(2, true) == 0:
            # Folks from other islands can't take me boat tours. I'm a fine enough captain fer any crew, but…newbies tend to ask too many navigation questions!
            MainNpc.OpenMessageWindow('TalkSNpc/kpp/SP_kpp:016', false)
        else:
            # Folks from other islands can't take advantage o' me boat tours. This ain't some sightseein' trip, ya know. This be a gruelin' journey over ragin' wav…
            MainNpc.OpenMessageWindow('TalkSNpc/kpp/SP_kpp:015', false)
    elif not System.EventFlags['cPlayer:KppFirstTalk']:
        # Now, what have we here? Yours be a face I've not seen before. Name's Kapp'n. What's yours? …<50:3>PLAYER, is it? Yar, that be a nice, fancy name, tha…
        MainNpc.OpenMessageWindow('TalkSNpc/kpp/SP_kpp:010', false)
        if System.EventFlags['cPlayer:MakePlayerAfterStartingKppTour']:
            # Well, I be a bit of a tour guide, see. I ferry folks to various wee islands in exchange fer miles.
            MainNpc.OpenMessageWindow('TalkSNpc/kpp/SP_kpp:010_01_02', false)
        else:
            # Well, I came here to ferry folks on tours to various wee islands in exchange fer miles.
            MainNpc.OpenMessageWindow('TalkSNpc/kpp/SP_kpp:010_01_01', false)
        # Might even take ye where thar be rare treasures. Me tours go to places ye can only reach with me boat. I can take ye almost anytime. Let me know when…
        MainNpc.OpenMessageWindow('TalkSNpc/kpp/SP_kpp:010_02', false)
        System.EventFlags['cPlayer:KppFirstTalk'] = true
        if not System.EventFlags['cLand:KppTourStart']:
            System.EventFlags['cLand:KppTourStartToday'] = true
            System.EventFlags['cLand:KppTourStart'] = true
        if not System.EventFlags['cPlayer:DocMysterytourExplain1st']:
            # Wait one nautical minute… I get the distinct feelin' ye've never been on a tour before. So I can't take ya. Yet.
            MainNpc.OpenMessageWindow('TalkSNpc/kpp/SP_kpp:012', false)
            # Me tours is fer veterans 'cause we be ridin' some wild waves. Can't have an untested swabbie aboard! At the very least, ye'll need to get yer feet we…
            MainNpc.OpenMessageWindow('TalkSNpc/kpp/SP_kpp:013', false)
    elif System.EventFlags['cPlayer:KppTakeTourTodayFlag']:
        # Alas, thar be a limit on me boat tours. Ye get one per day. Come back 'round another time, matey.
        MainNpc.OpenMessageWindow('TalkSNpc/kpp/SP_kpp:009', false)
    elif System.EventFlags['cPlayer:DocMysterytourExplain1st']:
        EventFlowSystemActor.UISonkatsuPointAppear()
        EventFlowSystemActor.SetTagFromSystem('cFlow', 'cDegit', 0, 1000, '')
        # Hm? Ye ready to take a tour?<10:4> Round- trip fare'll cost ye <90:4:0000> miles.
        MainNpc.OpenMessageWindow('TalkSNpc/kpp/SP_kpp:001', false)
        if EventFlowSystemActor.GeneralTalkChoice2() != 0:
            # Well, shiver me timbers through and through. Talk to me later if ye change yer mind.
            MainNpc.OpenMessageWindow('TalkSNpc/kpp/SP_kpp:005', false)
        elif EventFlowSystemActor.IsSharePlay(0):
            # Avast! How can ye be ready when ye be playin' with others? Me boat's only seaworthy fer a single passenger. Any more swabbies, an' she's likely to si…
            MainNpc.OpenMessageWindow('TalkSNpc/kpp/SP_kpp:008', false)
        elif EventFlowSystemActor.NetHasVisitor():
            # Aye, but now that I think on it… There's other folks on the island right now. It'd be an awful shame fer anyone to be left by their lonesome while ye…
            MainNpc.OpenMessageWindow('TalkSNpc/kpp/SP_kpp:007', false)
        elif EventFlowSystemActor.NetIsConnected():
            if EventFlowSystemActor.IsVillageGateOpened():
                # Aye, but…the winds seem ta favor some company, don't they? What with yer airport gates open and all? It'd be an awful shame fer any visitors to be le…
                MainNpc.OpenMessageWindow('TalkSNpc/kpp/SP_kpp:006', false)
            else:
                EventFlowSystemActor.NetEndSessionVillage('cEndVillageSession', false)
                run Sub_grp_Event9()
        else:
            run Sub_grp_Event9()
    else:
        # Me tours is fer veterans 'cause we be ridin' some wild waves. Can't have an untested swabbie aboard! At the very least, ye'll need to get yer feet we…
        MainNpc.OpenMessageWindow('TalkSNpc/kpp/SP_kpp:013', false)
 
local flow Sub_grp_Event9():
    if EventFlowSystemActor.HasLifeSupportPoint(1000, 'Now'):
        # Yar, that's <90:4:0000> miles, then.
        MainNpc.OpenMessageWindow('TalkSNpc/kpp/SP_kpp:002', true)
        run kpp_PayMile()
        run kpp_PreProcess()
        MainNpc.SetKappeiIslandReturnPos()
        # Time to set sail! Watch yer step as ye hop on board.
        MainNpc.OpenMessageWindow('TalkSNpc/kpp/SP_kpp:003', true)
        EventFlowSystemActor.SelectMysteryTour(2)
        MainNpc.NpcStartAS('NpcStandUpGround', true, true)
        fork:
            branch:
                run `00_System_StageChange`::ChangeStagerun `00_System_StageChange`::ChangeStage(FadeColorString='cBlack', TargetStage='cKppSeaDeparture', FadeOutKindString='cCircle', FadeInKindString='cCircle', FadeOutSpeed=0.0, FadeInSpeed='cNormal')
            branch:
                MainNpc.NpcStartAS('KppStandby', true, true)
            branch:
                Player.PlayerMoveToKppBoat()
                Player.TurnBody(12, 180.0)
            branch:
                EventFlowSystemActor@BgmActor.SoundTriggerEmit('Boat_Start', -1)
    else:
        # Avast! Ye don't got the miles! No miles, no tour…
        MainNpc.OpenMessageWindow('TalkSNpc/kpp/SP_kpp:004', false)
 
flow kpp_PayMile():
    EventFlowSystemActor.WaitFrame(5)
    Player.SmartPhone(0)
    Player.SmartPhone(4)
    EventFlowSystemActor.WaitFrame(5)
    Player.SmartPhoneSE(2, 'Phone_Control')
    EventFlowSystemActor.WaitFrame(30)
    Player.SmartPhoneSE(2, 'Phone_Sending')
    EventFlowSystemActor.WaitFrame(30)
    EventFlowSystemActor.LifeSupportPointCountDown(-1000, false)
    Player.SmartPhone(5)
    Player.SmartPhone(1)
    EventFlowSystemActor.WaitFrame(5)
 
flow kpp_PreProcess():
    EventFlowSystemActor.MiniGameSilentCancel()
    if System.EventFlags['cPlayer:EquipLicenseHelmet']:
        # Hold on tharrr. Are ye in the midst of usin' yer Island Designer gizmo? I can't have ye runnin' into trouble with it durin' the tour, so go ahead and…
        MainNpc.OpenMessageWindow('TalkSNpc/kpp/SP_kpp:011', true)
        System.EventFlags['cPlayer:EquipLicenseHelmet'] = false
        Player.PlayerOutfitFieldMakeToolKit('cOff')
 
