flow Root():
	if EventFlowSystemActor.EnvSameDate('cNewYear', 'cNowTime'):
		if System.EventFlags['cPlayer:SzaTalkAfterCountdown']:
			if System.EventFlags['cPlayer:SzaGotNewYearHat']:
				run Sza_Chat_After_Newyear()
			elif EventFlowSystemActor.ShoppingCapacity('cItemName', 5741):
				# Actually, I prepared a little present for everyone today.
				MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:043', false)
				run Sza_Get_StickLight()
			else:
				run Sza_Chat_After_Newyear()
		elif EventFlowSystemActor.IsMyVillage():
			System.EventFlags['cPlayer:SzaTalkAfterCountdown'] = true
			if (not System.EventFlags['cPlayer:SzaTaled1stTime']) and (not System.EventFlags['cPlayer:OfficeSzaIntroduction']) and (not System.EventFlags['cPlayer:SzaTalkFirstNotOffice']):
				System.EventFlags['cPlayer:SzaTalkFirstNotOffice'] = true
				# Happy almost New Year, PLAYER! Oh! How could I forget? We haven't met yet! I've just heard so much about you from Tom Nook that I feel like we're old…
				MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:064', false)
			else:
				# Happy New Year, PLAYER!
				MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:040', false)
			if (not System.EventFlags['cPlayer:SzaGotNewYearHat']) and (EventFlowSystemActor.ShoppingCapacity('cItemName', 5741)):
				if System.EventFlags['cPlayer:SzaTalkBeforeCountdown']:
					# Oh no… I don't think I've given you your present yet!
					MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:041', false)
				else:
					# Oh! That reminds me… I prepared a little present for everyone today.
					MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:042', false)
		else:
			System.EventFlags['cPlayerVisit:SzaVisitorTalkAfterCountdown'] = true
			# Happy New Year!<10:4> I hope this is the first of many visits you'll make to ISLAND in YEAR!
			MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:063', false)
			if (not System.EventFlags['cPlayer:SzaGotNewYearHat']) and (EventFlowSystemActor.ShoppingCapacity('cItemName', 5741)):
				if System.EventFlags['cPlayerVisit:SzaVisitorTalkBeforeCountdown']:
					# Oh no… I don't think I've given you your present yet!
					MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:041', false)
				else:
					# Oh! That reminds me… I prepared a little present for everyone today.
					MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:042', false)
				# I wanted to give it to you before the start of the new year, but we didn't get a chance to talk… Well, better late than never!
				MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:044', false)
				run Sza_Get_StickLight()
	elif EventFlowSystemActor.EnvHourCompare(23, 59, true, true) != 0:
		switch EventFlowSystemActor.RandomChoice3(3):
			case 0:
				# The new year is almost here!<10:7:001e0000>
				MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:030', false)
			case 1:
				# YEAR is almost over!<10:7:001e0000>
				MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:031', false)
			case 2:
				# AHHHH! I don't do well with change!<10:7:001e0000>
				MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:032', false)
	elif EventFlowSystemActor.IsMyVillage():
		if System.EventFlags['cPlayer:SzaTalkBeforeCountdown']:
			run Sza_Talk_Before_Newyear()
		else:
			System.EventFlags['cPlayer:SzaTalkBeforeCountdown'] = true
			if (not System.EventFlags['cPlayer:SzaTaled1stTime']) and (not System.EventFlags['cPlayer:OfficeSzaIntroduction']) and (not System.EventFlags['cPlayer:SzaTalkFirstNotOffice']):
				System.EventFlags['cPlayer:SzaTalkFirstNotOffice'] = true
				# Happy almost New Year, PLAYER! Oh! How could I forget? We haven't met yet! I've just heard so much about you from Tom Nook that I feel like we're old…
				MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:064', false)
				run Sub_grp_Event5()
			elif EventFlowSystemActor.EnvHourCompare(12, -1, true, true) == 0:
				# Ah! <50:3>PLAYER! Good morning!
				MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:001', false)
				run Sub_Event0()
			elif EventFlowSystemActor.EnvHourCompare(18, -1, true, true) == 0:
				# Oh, PLAYER! It's good to see you!
				MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:002', false)
				run Sub_Event0()
			elif EventFlowSystemActor.EnvHourCompare(23, -1, true, true) == 0:
				# Ah, PLAYER! I'm so glad you're here! You may have noticed, but Resident Services is closed today. Mr. Nook and I have been camped out here in the pla…
				MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:004', false)
				run Sub_grp_Event5()
			elif EventFlowSystemActor.EnvHourCompare(23, 55, true, true) == 0:
				# OH! <50:3>PLAYER! You're here!<10:4> I wasn't sure we'd see you since it's getting so late. But there's not enough time left in the year to worry abo…
				MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:005', false)
				run Sub_grp_Event5()
			else:
				# <50:3>PLAYER! FINALLY!!! I was honestly starting to worry that you wouldn't show! Well! Are you ready to ring in the new year? I know I am!
				MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:006', false)
				run Sub_grp_Event5()
	elif System.EventFlags['cPlayerVisit:SzaVisitorTalkBeforeCountdown']:
		run Sza_Talk_Before_Newyear()
	else:
		System.EventFlags['cPlayerVisit:SzaVisitorTalkBeforeCountdown'] = true
		# Thank you for visiting ISLAND! What timing!
		MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:034', false)
		if EventFlowSystemActor.EnvHourCompare(18, -1, true, true) == 0:
			# As you can see, we'll be ringing in the new year in the plaza tonight! But it's not midnight yet, so go enjoy the final day of YEAR, and come back he…
			MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:035', false)
		else:
			# The plaza is all decked out for the ISLAND Countdown!
			MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:036', false)
			if EventFlowSystemActor.EnvHourCompare(23, -1, true, true) == 0:
				# I hope you'll stick around and ring in the new year with all of us on ISLAND!
				MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:037', false)
			elif EventFlowSystemActor.EnvHourCompare(23, 55, true, true) == 0:
				# I look forward to ringing in the new year on ISLAND with you! Afterwards we're going to have a big fireworks show that you won't want to miss.
				MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:038', false)
			else:
				# We're only a few moments away from the new year. Time to get your celebration face on!
				MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:039', false)
		if not System.EventFlags['cPlayer:SzaGotNewYearHat']:
			run Sub_grp_Event5()

local flow Sub_Event0():
	# You may have noticed, but Resident Services is closed today. Mr. Nook and I will be camped out here in the plaza all day to prepare for tonight's Cou…
	MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:003', false)
	run Sub_grp_Event5()

local flow Sub_Event30():
	switch EventFlowSystemActor.RandomChoiceExcludePrevious4(4, true):
		case 0:
			# What do you think of my outfit? Such a special night deserves extra special attire!
			MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:026', true)
			return
		case 1:
			# YEAR really flew by so quickly…<10:4> Of course, I say that every year.
			MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:027', true)
			return
		case 2:
			# I wonder what kind of surprises next year will hold… Hopefully spending lots of time with my friends on ISLAND!
			MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:028', true)
			return
		case 3:
			if Player.PlayerIsUseCoordinate():
				run Sub_Event30()
			elif System.EventFlags['cPlayer:EquipLicenseHelmet']:
				run Sub_Event30()
			else:
				if (not EventFlowSystemActor.PlayerIsEquipItem(4799, 5186, 5187, 5192, 5188, 5190, 5189, 5191, 'cAny', true, false)) and (not EventFlowSystemActor.PlayerIsEquipItem(5946, 5947, 5948, 5953, 5949, 5951, 5950, 5952, 'cAny', true, false)):
					# You can buy a <item>New Year's hat from Mr. Nook if you visit his stall. You should go pick one up for today's festivities! It's nice to have an excu…
					MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:029_01', true)
				else:
					# That <item>New Year's hat looks marvelous on you, PLAYER! I like that we kind of match!
					MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:029_00', true)
				return

local flow Sub_grp_Event5():
	if EventFlowSystemActor.ShoppingCapacity('cItemName', 5741):
		# Oh, that's right! One more thing… I got you a present to help celebrate!
		MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:007', false)
		run Sza_Get_StickLight()
	else:
		# Oh, that's right! One more thing… I got you a present to help celebrate! Hmm… I can't give it to you while your pockets are full. So don't forget to …
		MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:008', true)

flow Sza_Chat_After_Newyear():
	if EventFlowSystemActor.EnvHourCompare(2, -1, true, true) == 0:
		switch EventFlowSystemActor.RandomChoiceExcludePrevious5(5, true):
			case 0:
				# Ah, the first fireworks of YEAR! Another reason to celebrate!
				MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:052', true)
			case 1:
				# Watching fireworks as beautiful as these gives me a lot of hope for the coming year.
				MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:053', true)
			case 2:
				# <10:12><10:14:0014>Yay, ISLAND! HOORAY!<10:9> Oh my! Sorry if I startled you! Whenever I see fireworks, my emotions tend to get…explosive!
				MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:054', true)
			case 3:
				# May this year shine as brightly as the fireworks lighting up the sky!
				MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:055', true)
			case 4:
				# There's nothing more joyful than ringing in the new year surrounded by old friends and new!
				MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:056', true)
	else:
		switch EventFlowSystemActor.RandomChoiceExcludePrevious5(5, true):
			case 0:
				# Those fireworks were just amazing! When I close my eyes, I can still see them… Blooming like giant flowers in the night sky…
				MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:057', true)
			case 1:
				# Now that the fireworks are over, I imagine folks will start making their way home and to bed!
				MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:058', true)
			case 2:
				# I'm so pleased we rang in YEAR with so much style and pizzazz!
				MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:059', true)
			case 3:
				# May this new year bring us both new friendships and adventures!
				MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:060', true)
			case 4:
				# Oh…my… Now that the roar of the fireworks has subsided…I'm having trouble keeping my eyes… HAPPY NEW YEAR!
				MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:061', true)

flow Sza_Chat_Before_Newyear():
	if EventFlowSystemActor.RandomChoice2(2) == 0:
		run Sub_Event30()
	else:
		switch EventFlowSystemActor.EnvTimeZone():
			case `05:00-07:59`, `08:00-11:59`, `12:00-15:59`:
				switch EventFlowSystemActor.RandomChoiceExcludePrevious3(3, true):
					case 0:
						# We have a big fireworks show set to start just after midnight. I'm so excited! I love fireworks! Of course, that's hours from now. I suggest squeezin…
						MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:016', true)
					case 1:
						# Today is the Countdown and tomorrow is New Year's Day… I hope you're ready for some non-stop celebration!
						MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:017', true)
					case 2:
						# I was up really early this morning to start setting up for today's events, so excuse…my…<10:4> AH! I CAN'T! The Countdown only happens once a year! S…
						MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:018', true)
				return
			case `16:00-18:59`:
				if EventFlowSystemActor.RandomChoiceExcludePrevious2(2, true) == 0:
					# It's starting to hit me that this is the last day of the year… But I have so much left to do!
					MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:019', true)
				else:
					# Everybody is starting to get fired up for the main event! Especially me!
					MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:020', true)
				return
			case `19:00-23:59`, `00:00-04:59`:
				if EventFlowSystemActor.EnvHourCompare(23, -1, true, true) == 0:
					run Sub_Event30()
				else:
					if EventFlowSystemActor.EnvHourCompare(23, 55, true, true) == 0:
						switch EventFlowSystemActor.RandomChoiceExcludePrevious3(3, true):
							case 0:
								# I was totally fine until a little bit ago, but now that there's less than an hour left…I'm a fluffball of nerves!
								MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:021', true)
							case 1:
								# It's time to say goodbye to YEAR! Did you keep any of your resolutions, PLAYER?
								MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:022', true)
							case 2:
								# OK! Less than an hour to go! Are you ready to count?!
								MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:023', true)
					elif EventFlowSystemActor.RandomChoiceExcludePrevious2(2, true) == 0:
						# AH! Look at the time! I wasn't built to handle THIS much excitement!
						MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:024', true)
					else:
						# Less than five minutes to go! Please direct your attention to the digital display.
						MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:025', true)
					return

flow Sza_Get_StickLight():
	MainNpc.MessageSuspend()
	MainNpc.SetDeliveryItemAtRandom(5741, true, 'cVillageRemakePattern', 0)
	MainNpc.NpcDelivery(1, 'Keep')
	if EventFlowSystemActor.EnvSameDate('cNewYear', 'cNowTime'):
		if EventFlowSystemActor.EnvHourCompare(2, -1, true, true) == 0:
			# It's a <item>light stick! The new year is here, but—as you can see—the celebration is far from over!
			MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:045', false)
		else:
			# It's a <item>light stick! Looks like the festivities are starting to die down… But I'd still like you to have this to commemorate the occasion!
			MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:046', false)
	else:
		# It's a <item>light stick! We're all going to wave them together once the Countdown begins.
		MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:011', false)
	System.EventFlags['cPlayer:SzaGotNewYearHat'] = true
	MainNpc.NpcDelivery(2, 'Default')

flow Sza_Talk_Before_Newyear():
	if System.EventFlags['cPlayer:SzaGotNewYearHat']:
		run Sza_Chat_Before_Newyear()
	elif EventFlowSystemActor.ShoppingCapacity('cItemName', 5741):
		# Oh, that's right! I still have your present!
		MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:012', false)
		run Sza_Get_StickLight()
	elif EventFlowSystemActor.RandomChoiceExcludePrevious2(2, true) == 0:
		# I'm still holding onto a present for you that'll come in handy during our celebration. Come find me when you have some more space in your pockets for…
		MainNpc.OpenMessageWindow('TalkSNpc/sza/GEvent/SP_sza_GEvent_Countdown:013', true)
	else:
		run Sza_Chat_Before_Newyear()
